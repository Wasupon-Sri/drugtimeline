<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Patient Medication Timeline</title>
    
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Import html2canvas for saving image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Use Inter font */
        body { 
            font-family: 'Inter', sans-serif; 
            /* Prevent pull-to-refresh on mobile */
            overscroll-behavior-y: none;
        }
        
        /* Sticky first column for medication names */
        .sticky-col { 
            position: -webkit-sticky; 
            position: sticky; 
            left: 0; 
            z-index: 10; 
            background-color: white; 
            /* Add a right border to separate it */
            border-right: 2px solid #e5e7eb;
        }
        
        /* Sticky header for dates */
        thead th { 
            position: -webkit-sticky; 
            position: sticky; 
            top: 0; 
            z-index: 20; 
            background-color: #f9fafb; /* Light gray bg for header */
            /* Default border */
            border: 1px solid #e5e7eb;
        }
        
        /* Ensure sticky header/col cells are above others */
        thead .sticky-col { 
            z-index: 30; 
        }

        /* Style for the timeline cells */
        .timeline-cell {
            height: 40px;
            border: 1px solid #e5e7eb; /* Cell borders */
            /* Prevent text selection during drag */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* For touch: prevent context menu */
            -webkit-touch-callout: none;
        }
        
        /* Give cells a default width, but allow them to be overridden */
        .daily-cell { min-width: 60px; }
        .daily-header { min-width: 60px; }

        /* Zoom Level 1 (Medium) */
        .zoom-1 .daily-cell,
        .zoom-1 .daily-header {
            min-width: 40px;
            font-size: 12px; /* text-xs */
            padding-left: 4px;
            padding-right: 4px;
        }

        /* REMOVED: Zoom Level 2 (Smallest) */

        /* Visual cue for the range being selected */
        .selection-preview {
            background-color: #d1d5db !important; /* Gray-300 */
            opacity: 0.7;
        }

        /* Style for the color picker */
        .color-picker-input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 24px; /* w-6 */
            height: 24px; /* h-6 */
            padding: 0;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 4px; /* rounded */
            cursor: pointer;
            flex-shrink: 0;
            background-color: white; /* Ensure background is white */
        }
        .color-picker-input:hover {
            border-color: #9ca3af; /* gray-400 */
        }
        /* Color picker inner swatch for webkit */
        .color-picker-input::-webkit-color-swatch-wrapper {
            padding: 2px; /* Inner padding for the border effect */
            border-radius: 3px;
        }
        .color-picker-input::-webkit-color-swatch {
            border: none;
            border-radius: 2px; /* Slightly smaller to show wrapper border */
        }
        /* Color picker inner swatch for firefox */
        .color-picker-input::-moz-color-swatch-wrapper {
             padding: 2px;
             border-radius: 3px;
        }
        .color-picker-input::-moz-color-swatch {
            border: none;
            border-radius: 2px;
        }

        /* Styles for edit mode controls to be hidden/shown */
        .edit-controls-container {
            display: flex; /* Default to show for edit mode */
            align-items: center;
            /* justify-content will be set by JS */
            gap: 8px; /* gap-2 */
            flex-shrink: 0; /* Don't let it shrink */
            margin-left: auto; /* Push to the right */
        }
        .presentation-mode .edit-controls-container {
            display: none;
        }
        .presentation-mode .name-editable[contenteditable="true"] {
            /* Disable contenteditable in presentation mode */
            contenteditable: false;
        }
        .presentation-mode .name-editable {
            /* Remove blue focus ring in presentation mode */
            outline: none;
            border: none;
        }

        /* --- Presentation Mode Border Removal --- */
        .presentation-mode .timeline-cell {
            /* Removes all borders from the main data grid cells */
            border-width: 0; 
        }
        .presentation-mode tbody .sticky-col {
            /* Removes all borders from the sticky name cells in the body */
            border-color: transparent; 
        }
        .presentation-mode thead .sticky-col {
            /* Removes all borders from the top-left sticky header cell */
            border-color: transparent;
        }
        .presentation-mode thead th {
            /* Targets the date headers */
            /* Removes all borders except the bottom one */
            border-top-color: transparent;
            border-left-color: transparent;
            border-right-color: transparent;
            /* The default border-bottom-color will be kept */
        }
        /* --- End Presentation Mode Styles --- */

        /* --- Swatch Style --- */
        .swatch {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #9ca3af; /* gray-400 */
            cursor: pointer;
            flex-shrink: 0;
        }
        .swatch:hover {
            border-width: 2px;
        }


        /* Adjust width of the sticky column for presentation vs. edit */
        /* Use a single width, let flex-col handle height on mobile */
        .edit-mode .sticky-col-med {
             width: 320px; 
        }
        .presentation-mode .sticky-col-med {
            width: 180px; /* Width for just name */
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center py-4 md:py-8">

    <!-- p-4 sm:p-6 for better mobile padding -->
    <div class="max-w-7xl mx-auto bg-white rounded-lg shadow-lg p-4 sm:p-6 w-full mb-32">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Interactive Medication Timeline</h1>

        <!-- Section 1: Date Range Setup -->
        <div class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">1. Set Timeline Date Range</h2>
            <!-- Stack vertically on mobile, row on sm+ -->
            <div class="flex flex-col sm:flex-row sm:flex-wrap gap-4 sm:items-end">
                <div class="w-full">
                    <label for="start-date" class="block text-sm font-medium text-gray-600">Start Date</label>
                    <input type="date" id="start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                </div>
                <div class="w-full">
                    <label for="end-date" class="block text-sm font-medium text-gray-600">End Date</label>
                    <input type="date" id="end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                </div>
                <button id="generate-grid" class="bg-blue-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 w-full sm:w-auto">
                    Generate Grid
                </button>
            </div>
            <p id="date-error" class="text-red-500 text-sm mt-2" style="display: none;"></p>
        </div>

        <!-- Section 2: Tools (Hidden initially) -->
        <div id="tools" class="hidden bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">2. Add Medications / Events</h2>
            <!-- Stack vertically on mobile, row on sm+ -->
            <div class="flex flex-col sm:flex-row sm:flex-wrap gap-4 sm:items-end">
                <div class="w-full sm:flex-1">
                    <label for="item-name" class="block text-sm font-medium text-gray-600">Item Name</label>
                    <input type="text" id="item-name" placeholder="e.g., Clopidogrel" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                </div>
                <div>
                    <button id="add-row" class="bg-green-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 w-full sm:w-auto">
                        Add Row
                    </button>
                </div>
            </div>
            <p id="item-error" class="text-red-500 text-sm mt-2" style="display: none;"></p>
        </div>

        <!-- Section 3: Display Options (Hidden initially) -->
        <div id="display-options" class="hidden bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">3. Display Options</h2>
            <!-- Stack vertically on mobile, row on sm+ -->
            <div class="flex flex-col sm:flex-row sm:flex-wrap items-start sm:items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-gray-600">Zoom:</span>
                    <button id="zoom-out" class="bg-gray-200 text-gray-700 w-8 h-8 rounded-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold">-</button>
                    <button id="zoom-in" class="bg-gray-200 text-gray-700 w-8 h-8 rounded-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold">+</button>
                    <button id="zoom-reset" class="bg-gray-200 text-gray-600 px-3 py-1 rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">Reset</button>
                </div>
                
                <!-- Spacer (hidden on mobile, visible sm+) -->
                <div class="border-l border-gray-300 h-8 hidden sm:block"></div>
                
                <!-- Edit Mode Toggle -->
                <div class="flex items-center gap-2">
                    <label for="edit-mode-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="edit-mode-toggle" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        <span class="ml-3 text-sm font-medium text-gray-600">Edit Mode</span>
                    </label>
                </div>

                <!-- Spacer (hidden on mobile, visible sm+) -->
                <div class="border-l border-gray-300 h-8 hidden sm:block"></div>
                
                <!-- Save/Copy buttons -->
                <div class="flex items-center gap-2">
                    <button id="save-png" class="bg-blue-600 text-white px-3 py-1 rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-sm">
                        Save as PNG
                    </button>
                </div>
            </div>
        </div>


        <!-- Section 4: Timeline Table -->
        <div id="timeline-container" class="overflow-x-auto w-full edit-mode">
            <!-- Table will be generated here -->
            <table id="timeline-table" class="w-full border-collapse" style="table-layout: auto;"> <!-- Set to auto -->
                <thead class="bg-gray-50">
                    <!-- Header row will be populated by JS -->
                </thead>
                <tbody>
                    <!-- Timeline rows will be populated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        
        // DOM Elements
        const generateBtn = document.getElementById('generate-grid');
        const addRowBtn = document.getElementById('add-row');
        const timelineContainer = document.getElementById('timeline-container'); // Changed variable name to avoid conflict
        const tableHead = document.querySelector('#timeline-table thead');
        const tableBody = document.querySelector('#timeline-table tbody');
        const toolsDiv = document.getElementById('tools');
        const displayOptionsDiv = document.getElementById('display-options');
        const dateError = document.getElementById('date-error');
        const itemError = document.getElementById('item-error');
        
        // --- Zoom Elements ---
        const tableEl = document.getElementById('timeline-table');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const zoomResetBtn = document.getElementById('zoom-reset');

        // --- Save Elements ---
        const savePngBtn = document.getElementById('save-png');

        // --- Edit Mode Toggle ---
        const editModeToggle = document.getElementById('edit-mode-toggle');


        // --- Data Model ---
        let dailyDates = []; // Master list of all individual dates
        // Stores all row data: Map<rowId, {name, color (hex), state: Map<dateString, 1>}>
        let gridState = new Map();
        let currentZoomLevel = 0; // 0 = default, 1 = mid
        const maxZoomLevel = 1; // CHANGED: Only one zoom level now

        /**
         * Updates the color for a given row in the state and live in the DOM.
         * @param {string} rowId - The unique ID of the row.
         * @param {string} newColor - The new hex color string.
         */
        function updateRowColor(rowId, newColor) {
            const rowInfo = gridState.get(rowId);
            if (!rowInfo) return;

            // 1. Update the state
            rowInfo.color = newColor;

            // 2. Find the row element in the DOM
            const rowElement = tableBody.querySelector(`tr[data-row-id="${rowId}"]`);
            if (!rowElement) return;
            
            // 3. Live-update the color of all 'on' cells in this row
            rowElement.querySelectorAll('.timeline-cell').forEach(cell => {
                const cellDates = JSON.parse(cell.getAttribute('data-dates'));
                const isColored = cellDates.some(dateStr => rowInfo.state.has(dateStr));
                if (isColored) {
                    cell.style.backgroundColor = newColor;
                }
            });
        }

        // --- Event Listeners ---

        // Generate Grid button
        generateBtn.addEventListener('click', () => {
            const startDateEl = document.getElementById('start-date');
            const endDateEl = document.getElementById('end-date');
            
            if (!startDateEl.value || !endDateEl.value) {
                dateError.textContent = 'Please select both a start and end date.';
                dateError.style.display = 'block';
                return;
            }
            
            const start = new Date(startDateEl.value + 'T00:00:00'); // Fix timezone issues
            const end = new Date(endDateEl.value + 'T00:00:00');

            if (start > end) {
                dateError.textContent = 'Start date must be before or the same as the end date.';
                dateError.style.display = 'block';
                return;
            }
            
            dateError.style.display = 'none';
            toolsDiv.classList.remove('hidden');
            displayOptionsDiv.classList.remove('hidden');

            // Populate the master list of daily dates
            dailyDates = [];
            let currentDate = new Date(start);
            while (currentDate <= end) {
                dailyDates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Reset zoom and do initial render
            currentZoomLevel = 0;
            renderTable();
        });

        // Add Row button
        addRowBtn.addEventListener('click', () => {
            const itemNameInput = document.getElementById('item-name');
            const name = itemNameInput.value.trim();

            if (!name) {
                itemError.textContent = 'Please enter an item name.';
                itemError.style.display = 'block';
                return;
            }

            itemError.style.display = 'none';
            
            const defaultColorHex = '#d1d5db'; // Default to gray-300
            const rowId = crypto.randomUUID();
            
            // Add new row to our data model
            gridState.set(rowId, { 
                name: name, 
                color: defaultColorHex, // Store default hex color
                state: new Map() // State is map of dateString -> 1
            });
            
            // Re-render the table to show the new row
            renderTable();
            
            // Clear inputs
            itemNameInput.value = ''; 
        });

        // --- Zoom Listeners ---
        zoomInBtn.addEventListener('click', () => {
            if (currentZoomLevel > 0) {
                currentZoomLevel--;
                applyZoom();
            }
        });

        zoomOutBtn.addEventListener('click', () => {
            // Use maxZoomLevel
            if (currentZoomLevel < maxZoomLevel) {
                currentZoomLevel++;
                applyZoom();
            }
        });

        zoomResetBtn.addEventListener('click', () => {
            currentZoomLevel = 0;
            applyZoom();
        });

        function applyZoom() {
            // Remove old zoom classes
            tableEl.classList.remove('zoom-0', 'zoom-1'); // Removed zoom-2
            // Add current one
            tableEl.classList.add('zoom-' + currentZoomLevel);
        }

        // --- Edit Mode Toggle Listener ---
        editModeToggle.addEventListener('change', () => {
            if (editModeToggle.checked) {
                timelineContainer.classList.remove('presentation-mode');
                timelineContainer.classList.add('edit-mode');
            } else {
                timelineContainer.classList.remove('edit-mode');
                timelineContainer.classList.add('presentation-mode');
            }
            renderTable(); // Re-render to apply/remove controls
        });

        // --- Save Listener ---
        savePngBtn.addEventListener('click', saveAsImage);

        /**
         * Prepares table for capture, runs html2canvas, and triggers download.
         */
        async function saveAsImage() {
            // Store original edit mode state
            const originalEditModeState = editModeToggle.checked;

            // Temporarily switch to presentation mode for clean capture
            editModeToggle.checked = false;
            editModeToggle.dispatchEvent(new Event('change')); // Trigger change to apply styles
            
    
